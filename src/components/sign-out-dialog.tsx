/**
 * Sign Out Dialog Component
 *
 * Confirmation dialog for user logout
 * - Shows confirmation before logging out
 * - Supports both local and OIDC (Keycloak) authentication
 * - Preserves return URL for re-login
 */

'use client'

import { useTransition } from 'react'
import { useAuthStore } from '@/stores/auth-store'
import { ConfirmDialog } from '@/components/confirm-dialog'
import { env, isLocalAuthOnly } from '@/lib/env'
import { localLogoutAction } from '@/features/auth/actions/local-auth-actions'

// ============================================
// TYPES
// ============================================

interface SignOutDialogProps {
  /**
   * Whether the dialog is open
   */
  open: boolean

  /**
   * Callback when dialog open state changes
   */
  onOpenChange: (open: boolean) => void

  /**
   * Optional custom redirect URL after logout
   * If not provided, redirects to sign-in page
   */
  redirectTo?: string
}

// ============================================
// COMPONENT
// ============================================

export function SignOutDialog({
  open,
  onOpenChange,
  redirectTo,
}: SignOutDialogProps) {
  const logout = useAuthStore((state) => state.logout)
  const clearAuth = useAuthStore((state) => state.clearAuth)
  const [isPending, startTransition] = useTransition()

  /**
   * Handle sign out confirmation
   * - For local auth: calls server action to clear cookies and redirect
   * - For OIDC: redirects to Keycloak logout endpoint
   */
  const handleSignOut = () => {
    // Close dialog first
    onOpenChange(false)

    // Clear localStorage user data
    try {
      localStorage.removeItem('rediver_user')
    } catch {
      // Ignore localStorage errors
    }

    if (isLocalAuthOnly()) {
      // Local auth logout
      // Clear client-side state first
      clearAuth()

      // Call server action to clear cookies and redirect
      startTransition(async () => {
        await localLogoutAction(redirectTo || '/login')
      })
    } else {
      // OIDC (Keycloak) logout
      const postLogoutUrl = redirectTo || window.location.origin
      logout(postLogoutUrl)
    }
  }

  return (
    <ConfirmDialog
      open={open}
      onOpenChange={onOpenChange}
      title='Sign out'
      desc='Are you sure you want to sign out? You will need to sign in again to access your account.'
      confirmText={isPending ? 'Signing out...' : 'Sign out'}
      cancelBtnText='Cancel'
      destructive
      handleConfirm={handleSignOut}
      className='sm:max-w-sm'
    />
  )
}

// ============================================
// SIMPLE SIGN OUT BUTTON (No Dialog)
// ============================================

/**
 * Simple sign out button without confirmation dialog
 * Use this when you want immediate logout without confirmation
 */
export function SignOutButton({
  children,
  className,
  redirectTo,
}: {
  children?: React.ReactNode
  className?: string
  redirectTo?: string
}) {
  const logout = useAuthStore((state) => state.logout)
  const clearAuth = useAuthStore((state) => state.clearAuth)
  const [isPending, startTransition] = useTransition()

  const handleClick = () => {
    // Clear localStorage user data
    try {
      localStorage.removeItem('rediver_user')
    } catch {
      // Ignore localStorage errors
    }

    if (isLocalAuthOnly()) {
      clearAuth()
      startTransition(async () => {
        await localLogoutAction(redirectTo || '/login')
      })
    } else {
      const postLogoutUrl = redirectTo || window.location.origin
      logout(postLogoutUrl)
    }
  }

  return (
    <button onClick={handleClick} className={className} disabled={isPending}>
      {isPending ? 'Signing out...' : (children || 'Sign out')}
    </button>
  )
}
